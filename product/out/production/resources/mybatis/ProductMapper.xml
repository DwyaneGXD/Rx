<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.oasis.rx.product.dao.ProductDao">

    <!-- 修改产品时判断是否已存在 -->
    <select id="findIsRepeat" resultType="com.oasis.rx.product.entity.ProductEntity">
        SELECT id,product_name,produce_factory,standard
        FROM t_product
        WHERE
        product_name =#{arg0} AND produce_factory=#{arg1} AND standard=#{arg2} AND is_delete =0;
    </select>

    <!-- 医生端-模糊加载产品信息以及返回商品表中的来源-->
    <resultMap type="com.oasis.rx.product.entity.vo.ProductModel" id="List_result">
        <id column="id" property="id"/>
        <result column="product_name" property="name"/>
        <result column="produce_factory" property="produceFactory"/>
        <result column="standard" property="standard"/>
        <result column="category" property="category"/>
        <result column="effect" property="effect"/>
        <result column="is_otc" property="isOtc"/>
        <result column="picture" property="picture"/>
        <result column="comment" property="comment"/>
        <result column="operator" property="operator"/>
        <!-- <collection property="commodityEntities" column="id" select="getList"> -->
        <collection column="source" property="sources" ofType="java.lang.Integer">
        </collection>
    </resultMap>
    <select id="findProductLike" resultMap="List_result">
        <bind name="_dataTrim" value="'%'+dataTrim+'%'"/>
        SELECT
        co.source,
        p.id,
        p.product_name,
        p.standard,
        p.produce_factory,
        p.category,
        p.effect,
        p.is_otc,
        p.picture,
        p.comment,
        p.operator
        FROM
        t_product p,
        t_commodity co
        <where>
            (
            p.product_name like #{_dataTrim}
            )
            AND co.product_id = p.id AND p.is_delete=0 AND co.is_delete=0 AND p.produce_factory != ''
        </where>
    </select>

    <!-- 后台-根据产品名称和类别分页查询产品信息 -->
    <select id="findProductsPage" resultType="com.oasis.rx.product.entity.ProductEntity">
        <bind name="_nameLike" value="'%'+nameLike+'%'"/>
        <bind name="_isOtcLike" value="isOtcLike+'%'"/>
        SELECT
        p.id,
        p.product_name as productName,
        p.standard,
        p.produce_factory as produceFactory,
        p.category,
        p.effect,
        p.is_otc as isOtc,
        p.picture,
        p.comment,
        p.operator
        FROM
        t_product p
        WHERE
        <if test="nameLike != null and isOtcLike != null">
            p.product_name like #{_nameLike}
            AND
            p.is_otc like #{_isOtcLike}
        </if>
        AND p.is_delete=0
    </select>

    <!-- 后台-修改产品信息,以及商品的名称 -->
    <update id="updateId" parameterType="com.oasis.rx.product.entity.vo.UpdateProductModel">
        update t_product p LEFT JOIN t_commodity co ON p.id=co.product_id
        <set>
            <if test="name != null">
                p.product_name = #{name,jdbcType=VARCHAR},
            </if>
            <if test="produceFactory != null">
                p.produce_factory = #{produceFactory,jdbcType=VARCHAR},
            </if>
            <if test="standard != null">
                p.standard = #{standard,jdbcType=VARCHAR},
            </if>
            <if test="category != null">
                p.category = #{category,jdbcType=INTEGER},
            </if>
            <if test="effect != null">
                p.effect = #{effect,jdbcType=VARCHAR},
            </if>
            <if test="isOtc != null">
                p.is_otc = #{isOtc,jdbcType=INTEGER},
            </if>
            <if test="picture != null">
                p.picture = #{picture,jdbcType=VARCHAR},
            </if>
            <if test="operator != null">
                p.operator = #{operator,jdbcType=VARCHAR},
            </if>
            <if test="isDelete != null">
                p.is_delete = #{isDelete,jdbcType=INTEGER},
            </if>
            <if test="createTime != null">
                p.create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                p.update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="comment != null">
                p.comment = #{comment,jdbcType=VARCHAR},
            </if>
            <if test="name != null">
                co.commodity_name = #{name,jdbcType=VARCHAR},
            </if>
        </set>
        WHERE p.id = #{id,jdbcType=VARCHAR} AND p.is_delete = 0
    </update>

    <!-- 后端-删除产品及其商品 -->
    <delete id="deleteProduct" parameterType="java.lang.String">
        UPDATE t_product p LEFT JOIN t_commodity co ON p.id=co.product_id
        SET p.is_delete=1, co.is_delete=1
        WHERE p.id=#{id} AND p.is_delete=0
    </delete>

    <!-- 后台-根据产品名称模糊查询产品id -->
    <select id="findProductIdByName" resultType="com.oasis.rx.product.entity.ProductEntity">
        <bind name="_nameLike" value="'%'+nameLike+'%'"/>
        SELECT
        p.id,
        p.product_name as productName
        FROM
        t_product p
        <where>
            <if test="nameLike != null and nameLike != &quot;&quot;">
                p.product_name LIKE #{_nameLike}
            </if>
            AND p.is_delete=0
        </where>
    </select>
</mapper>